{% extends "base.html" %}

{% block title %}{{ site_name }}{% endblock %}

{% block content %}
    <div class="card tag-card">
        <h3>Tags</h3>
        <div class="metadata">
            <div class="tags-accordion">
                <span class="tags tags-wrapper">
                    {% for tag in tags %}
                        <a href="tags/{{ tag }}.html" class="tag-item">{{ tag }}</a>
                    {% endfor %}
                </span>
                {% if tags|length > 5 %}
                    <button class="show-more-tags">Show More</button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="message-list">
        {% for post in posts %}
            <div class="card">
                <h3><a href="messages/{{ post.metadata.id }}.html">{{ post.metadata.title }}</a></h3>
                <div class="metadata">
                    <span>{{ post.date }}</span>
                    {% if post.metadata.tags %}
                        <span class="tags">
                            {% for tag in post.metadata.tags %}
                                <a href="tags/{{ tag }}.html">{{ tag }}</a>
                            {% endfor %}
                        </span>
                    {% endif %}
                </div>
                <div class="content-wrapper">
                    {{ post.html | safe }}
                </div>
            </div>
        {% endfor %}
    </div>

    <nav class="pagination">
        {% if total_pages > 1 %}
            {% if current_page > 1 %}
                <a href="{% if current_page == 2 %}index.html{% else %}page-{{ current_page - 1 }}.html{% endif %}">Previous</a>
            {% endif %}

            {% for page_num in page_numbers %}
                {% if page_num == current_page %}
                    <a href="#" class="active">{{ page_num }}</a>
                {% else %}
                    <a href="{% if page_num == 1 %}index.html{% else %}page-{{ page_num }}.html{% endif %}">{{ page_num }}</a>
                {% endif %}
            {% endfor %}

            {% if current_page < total_pages %}
                <a href="page-{{ current_page + 1 }}.html">Next</a>
            {% endif %}
        {% endif %}
    </nav>

    <div id="scroll-trigger"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tagsWrapper = document.querySelector('.tags-wrapper');
    const showMoreTags = document.querySelector('.show-more-tags');

    if (showMoreTags) {
        const tags = Array.from(tagsWrapper.querySelectorAll('.tag-item'));
        const initialVisibleTags = 5;
        let isExpanded = false;

        // Initially hide excess tags
        tags.slice(initialVisibleTags).forEach(tag => {
            tag.style.display = 'none';
        });

        if (tags.length <= initialVisibleTags) {
            showMoreTags.style.display = 'none';
        }

        showMoreTags.addEventListener('click', () => {
            if (isExpanded) {
                tags.slice(initialVisibleTags).forEach(tag => {
                    tag.style.display = 'none';
                });
                showMoreTags.textContent = 'Show More';
            } else {
                tags.forEach(tag => {
                    tag.style.display = 'inline-block';
                });
                showMoreTags.textContent = 'Show Less';
            }
            isExpanded = !isExpanded;
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if (window.location.protocol === 'file:') {
        return;
    }

    const paginationNav = document.querySelector('.pagination');
    if (paginationNav) {
        paginationNav.style.display = 'none';
    }

    const messageList = document.querySelector('.message-list');
    const scrollTrigger = document.getElementById('scroll-trigger');
    let currentPage = 1;
    const totalPages = {{ total_pages }};

    const loadMorePosts = () => {
        currentPage++;
        if (currentPage <= totalPages) {
            fetch(`page-${currentPage}.html`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newMessages = doc.querySelector('.message-list').innerHTML;
                    messageList.insertAdjacentHTML('beforeend', newMessages);
                })
                .catch(error => console.error('Error fetching next page:', error));
        } else {
            observer.unobserve(scrollTrigger); // Stop observing when all pages are loaded
        }
    };

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
            loadMorePosts();
        }
    }, { threshold: 1.0 });

    if (totalPages > 1) {
        observer.observe(scrollTrigger);
    }
});
</script>
{% endblock %}
