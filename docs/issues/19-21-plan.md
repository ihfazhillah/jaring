# Plan for Issues 19-21

This document outlines the plan for implementing issues 19, 20, and 21.

---

## Issue 19: Social Share Image and Excerpt Rendering

**Goal:** Ensure that shared links have proper Open Graph meta tags for rich previews on social media.

**Plan:**

1.  **Update `parse_file`:**
    *   Generate a plain text excerpt from the post content. This can be the first 150 characters of the content, stripped of any markdown.
    *   Add this excerpt to the post dictionary that is returned.

2.  **Update `templates/base.html`:**
    *   In the `<head>` section, add the following Open Graph meta tags:
        ```html
        <meta property="og:title" content="{{ post.metadata.title }}">
        <meta property="og:type" content="article">
        <meta property="og:url" content="{{ site_url }}/messages/{{ post.metadata.id }}.html">
        <meta property="og:description" content="{{ post.excerpt }}">
        {% if post.metadata.og_image %}
        <meta property="og:image" content="{{ site_url }}/{{ post.metadata.og_image }}">
        {% endif %}
        ```
    *   This change will only apply if a `post` object is in the context, which is true for message pages.

3.  **Update `main` function:**
    *   Ensure `site_url` is passed to the template rendering context.

---

## Issue 20: Easy and Correct File Linking

**Goal:** Implement a simple `[[link-target]]` syntax for internal linking.

**Plan:**

1.  **Update `main` function:**
    *   After parsing all posts, create a dictionary that maps post IDs and filenames to their corresponding post objects. This will be used for quick lookups.

2.  **Create a new function `resolve_internal_links(content, post_map)`:**
    *   This function will take the content of a post and the post map as input.
    *   It will use a regular expression to find all occurrences of `[[link-target]]`.
    *   For each found link, it will look up the `link-target` in the `post_map`.
    *   If a match is found, it will replace `[[link-target]]` with `<a href="../messages/{{ post.metadata.id }}.html">{{ post.metadata.title }}</a>`.
    *   If no match is found, it will log a warning and render the link as plain text with a note about the broken link.

3.  **Update `parse_file`:**
    *   The `parse_file` function will need to be called in a way that it has access to the `post_map`. A possible approach is to do a two-pass rendering. The first pass parses the metadata and content, and the second pass resolves the links.

---

## Issue 21: RTL, LTR, and Mixed-Direction Text Handling

**Goal:** Add support for RTL and mixed-direction text in HTML by automatically detecting the direction of each line.

**Plan:**

1.  **Update `templates/base.html`:**
    *   Add a `dir` attribute to the `<html>` tag based on a `direction` metadata in the post's frontmatter: `<html lang="en" {% if post and post.metadata.direction == 'rtl' %}dir="rtl"{% endif %}>`. This will set the primary direction for the page.

2.  **Create a new function `auto_detect_direction(content)`:**
    *   This function will be called from `parse_file` before the markdown to HTML conversion.
    *   It will split the content into individual lines.
    *   For each line, it will check for the presence of Arabic characters (e.g., using the `[\u0600-\u06FF]` regex) and Latin characters.
    *   If a line contains only Arabic characters, it will be wrapped in `<div dir="rtl">...</div>`.
    *   If a line contains both Arabic and Latin characters, it will be wrapped in `<div dir="ltr">...</div>`.
    *   Lines with only Latin characters will be left unchanged.
    *   The function will then join the lines back together and return the modified content.

3.  **Update `parse_file`:**
    *   Call the new `auto_detect_direction` function on the content before converting it to HTML.
